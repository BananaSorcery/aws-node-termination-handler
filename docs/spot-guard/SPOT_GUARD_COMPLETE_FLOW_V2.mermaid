graph TD
    subgraph "PHASE 1: REBALANCE DETECTION & RESPONSE"
        A[1. IMDS Rebalance Check] -->|Recommendation Detected| B(2. Scale Up Spot ASG);
        B --> C{3. Wait for New Instance};
    end

    C -->|âœ… Success: New Spot Node is InService| SuccessPath;
    C -->|âŒ Failure: Timeout or Capacity Issue| FailurePath;

    subgraph "SUCCESS PATH"
        SuccessPath[4. Taint & Drain Interrupted Spot Node] --> Phase2_Start;
        
        subgraph "PHASE 2: CA PROTECTION (On New Spot Node)"
            Phase2_Start[5. CA Protector Starts] --> Phase2_Apply["6. Apply 'scale-down-disabled' Annotation"];
            Phase2_Apply --> Phase2_End["7. Auto-Remove Protection After Expiry"];
            Phase2_End --> Success_Complete([âœ… Spot Replacement Complete!]);
        end
    end

    subgraph "FAILURE PATH (FALLBACK TO ON-DEMAND)"
        FailurePath("ðŸ”„ Fallback: Scale Up On-Demand ASG") --> WaitInservice;
        WaitInservice("ðŸ”„ Wait for On-Demand instance to be InService") --> FailurePath_Taint;
        FailurePath_Taint[4. Taint & Drain Interrupted Spot Node] --> Phase3_Start;

        subgraph "PHASE 3: SELF-MONITORING (On New On-Demand Node)"
            Phase3_Start[8. Self-Monitor Starts] --> J{9. Check: Min Wait Time?};
            J -- âœ… Yes --> K{10. Check: Spot Health?};
            J -- âŒ No --> Phase3_Start;
            K -- âœ… Yes --> L{11. Check: Cluster Util?};
            K -- âŒ No --> Phase3_Start;
            L -- âœ… Yes --> P{12. Check: PDBs Safe?};
            L -- âŒ No, Too High --> M("ðŸš€ Attempt Smart Pre-Scale");
            M --> N{Pre-scale OK?};
            N -- âœ… Yes --> L;
            N -- âŒ No, Failure --> Phase3_Start;
            P -- âœ… Yes --> Q["13. ðŸŽ¯ Scale Down This On-Demand Node"];
            P -- âŒ No --> Phase3_Start;
            Q --> Failure_Complete([âœ… Scale-Down Complete!]);
        end
    end
